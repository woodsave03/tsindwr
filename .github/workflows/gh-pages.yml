# This is a basic workflow to help you get started with Actions

name: Deploy MkDocs

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: write

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "deploy"
  deploy:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compute Sunder version from tags
        id: version
        run: |
          # Find the latest semver-like tag (e.g., v0.1.0)
          TAG=$(git describe --tags --match "v[0-9]*.[0-9]*.[0-9]*" --abbrev=0)
          echo "Base tag: ${TAG}"

          # Strip leading 'v'
          BASE=${TAG#v}

          # Commit count since that tag = patch version
          PATCH=$(git rev-list "${TAG}..HEAD" --count)

          # Compose MAJOR.MINOR from tag, PATCH from commit count
          MAJOR=$(echo "$BASE" | cut -d. -f1)
          MINOR=$(echo "$BASE" | cut -d. -f2)
          VERSION="${MAJOR}.${MINOR}.${PATCH}"

          echo "Computed Sunder version: ${VERSION}"

          sed -i "s/^\(\s*sunder_version:\s*\).*/\1\"${VERSION}\"/" mkdocs.yml
          grep "sunder_version:" mkdocs.yml
          
          # Expose values to later steps
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_full=${TAG}" >> $GITHUB_OUTPUT
          echo "tag_version=${BASE}" >> $GITHUB_OUTPUT
          echo "tag_patch=${PATCH}" >> $GITHUB_OUTPUT
          echo "tag_feature=v${MAJOR}.${MINOR}.0" >> $GITHUB_OUTPUT
          
          if [ "$PATCH" -eq 0 ]; then
            echo "announce_release=true" >> $GITHUB_OUTPUT
          else
            echo "announce_release=false" >> $GITHUB_OUTPUT
          fi

      # Runs a single command using the runners shell
      - name: Install MkDocs and plugins
        run: |
          pip install --upgrade pip
          pip install \
            mkdocs \
            mkdocs-material \
            pymdown-extensions \
            mkdocs-obsidian-support-plugin \
            mkdocs-roamlinks-plugin

      - name: Build site
        run: mkdocs build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site

      - name: Send release notes to Supabase / Discord (idempotent)
        env:
          SUPABASE_RELEASE_FUNCTION_URL: ${{ secrets.SUPABASE_RELEASE_FUNCTION_URL }}
        run: |
          set -euo pipefail
          
          TAG="${{ steps.version.outputs.tag_feature }}"
          NOTES_FILE="release-notes/${TAG}.json"
          
          if [ ! -f "$NOTES_FILE" ]; then
            echo "No release notes file found for ${TAG} at ${NOTES_FILE}, skipping announcement."
            exit 0
          fi
          
          # Read the `discord_announcement_sent` flag, defaulting to fals if missing.
          # Requires `jq` to be installed on the runner (it is by default on ubuntu-latest).
          DISCORD_SENT=$(js -r '.discord_announcement_sent // false' "$NOTES_FILE")
          
          if [ "$DISCORD_SENT" = "true" ]; then
            echo "Release notes for ${TAG} have already been sent to Discord, skipping announcement."
            exit 0
          fi
          
          echo "Sending release notes from ${NOTES_FILE} to Supabase..."
          
          curl -sS -X POST "$SUPABASE_RELEASE_FUNCTION_URL" \
            -H "Content-Type: application/json" \
            -d @"$NOTES_FILE"
          
          echo "Marking discord_annoucement_sent as true in ${NOTES_FILE}..."
          tmpfile="$(mktemp)"
          jq '.discord_announcement_sent = true' "$NOTES_FILE" > "$tmpfile"
          mv "$tmpfile" "$NOTES_FILE"
          
          # Commit the updated release notes so we don't send again next run
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$NOTES_FILE"
          git commit -m "Mark Discord announcement sent for ${TAG} release notes" || echo "No changes to commit"
          git push origin main